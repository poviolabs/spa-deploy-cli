version: 2.1

orbs:
  aws-cli: circleci/aws-cli@2.0.0

jobs:

  build-and-deploy: &build-and-deploy
    docker:
      - image: circleci/node:14.15
    steps:
      - checkout
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - yarn-packages-v1-{{ .Branch }}-{{ checksum "yarn.lock" }}
            - yarn-packages-v1-{{ .Branch }}-
            - yarn-packages-v1-
      - run:
          name: Install Dependencies
          command: yarn install --immutable --cache-folder ~/.cache/yarn

      - save_cache:
          paths:
            - ~/.cache/yarn
          key: yarn-packages-v1-{{ .Branch }}-{{ checksum "yarn.lock" }}

      # - run: npm run task:eslint

      - run: npm run build

      # RUN DEPLOY SCRIPT
      #  add version and variables to header
      #  create targeted invalidations
      - run:
          name: Deploy to S3
          command: yarn spa-deploy-cli

  myapp-dev:
    <<: *build-and-deploy
    environment:
      STAGE: myapp-dev
      # add variables to .env.${STAGE}
      # add secrets to circleci environment
      # secrets can be prefixed with STAGE_${STAGE}_

workflows:
  version: 2
  build-and-deploy:
    jobs:

      - myapp-dev:
          filters:
            tags:
              ignore: /.*/
            branches:
              only: myapp-dev

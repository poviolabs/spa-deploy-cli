#!/usr/bin/env node
import { createRequire } from 'module'; const require = createRequire(import.meta.url);import * as url from 'url';const __dirname = url.fileURLToPath(new URL('.', import.meta.url));
"use strict";var wt=Object.create;var K=Object.defineProperty;var we=Object.getOwnPropertyDescriptor;var Ct=Object.getOwnPropertyNames;var St=Object.getPrototypeOf,xt=Object.prototype.hasOwnProperty;var i=(e,t)=>K(e,"name",{value:t,configurable:!0});var Et=(e,t,n,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Ct(t))!xt.call(e,r)&&r!==n&&K(e,r,{get:()=>t[r],enumerable:!(o=we(t,r))||o.enumerable});return e};var w=(e,t,n)=>(n=e!=null?wt(St(e)):{},Et(t||!e||!e.__esModule?K(n,"default",{value:e,enumerable:!0}):n,e));var h=(e,t,n,o)=>{for(var r=o>1?void 0:o?we(t,n):t,s=e.length-1,l;s>=0;s--)(l=e[s])&&(r=(o?l(t,n,r):l(r))||r);return o&&r&&K(t,n,r),r};var ht=w(require("yargs"),1),bt=require("yargs/helpers");var Ce=i((e=0)=>t=>`\x1B[${t+e}m`,"wrapAnsi16"),Se=i((e=0)=>t=>`\x1B[${38+e};5;${t}m`,"wrapAnsi256"),xe=i((e=0)=>(t,n,o)=>`\x1B[${38+e};2;${t};${n};${o}m`,"wrapAnsi16m"),p={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],gray:[90,39],grey:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgGray:[100,49],bgGrey:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}},Qt=Object.keys(p.modifier),vt=Object.keys(p.color),At=Object.keys(p.bgColor),Xt=[...vt,...At];function Pt(){let e=new Map;for(let[t,n]of Object.entries(p)){for(let[o,r]of Object.entries(n))p[o]={open:`\x1B[${r[0]}m`,close:`\x1B[${r[1]}m`},n[o]=p[o],e.set(r[0],r[1]);Object.defineProperty(p,t,{value:n,enumerable:!1})}return Object.defineProperty(p,"codes",{value:e,enumerable:!1}),p.color.close="\x1B[39m",p.bgColor.close="\x1B[49m",p.color.ansi=Ce(),p.color.ansi256=Se(),p.color.ansi16m=xe(),p.bgColor.ansi=Ce(10),p.bgColor.ansi256=Se(10),p.bgColor.ansi16m=xe(10),Object.defineProperties(p,{rgbToAnsi256:{value(t,n,o){return t===n&&n===o?t<8?16:t>248?231:Math.round((t-8)/247*24)+232:16+36*Math.round(t/255*5)+6*Math.round(n/255*5)+Math.round(o/255*5)},enumerable:!1},hexToRgb:{value(t){let n=/[a-f\d]{6}|[a-f\d]{3}/i.exec(t.toString(16));if(!n)return[0,0,0];let[o]=n;o.length===3&&(o=[...o].map(s=>s+s).join(""));let r=Number.parseInt(o,16);return[r>>16&255,r>>8&255,r&255]},enumerable:!1},hexToAnsi256:{value:t=>p.rgbToAnsi256(...p.hexToRgb(t)),enumerable:!1},ansi256ToAnsi:{value(t){if(t<8)return 30+t;if(t<16)return 90+(t-8);let n,o,r;if(t>=232)n=((t-232)*10+8)/255,o=n,r=n;else{t-=16;let c=t%36;n=Math.floor(t/36)/5,o=Math.floor(c/6)/5,r=c%6/5}let s=Math.max(n,o,r)*2;if(s===0)return 30;let l=30+(Math.round(r)<<2|Math.round(o)<<1|Math.round(n));return s===2&&(l+=60),l},enumerable:!1},rgbToAnsi:{value:(t,n,o)=>p.ansi256ToAnsi(p.rgbToAnsi256(t,n,o)),enumerable:!1},hexToAnsi:{value:t=>p.ansi256ToAnsi(p.hexToAnsi256(t)),enumerable:!1}}),p}i(Pt,"assembleStyles");var Rt=Pt(),T=Rt;var H=w(require("process"),1),ve=w(require("os"),1),ne=w(require("tty"),1);function A(e,t=globalThis.Deno?globalThis.Deno.args:H.default.argv){let n=e.startsWith("-")?"":e.length===1?"-":"--",o=t.indexOf(n+e),r=t.indexOf("--");return o!==-1&&(r===-1||o<r)}i(A,"hasFlag");var{env:m}=H.default,Z;A("no-color")||A("no-colors")||A("color=false")||A("color=never")?Z=0:(A("color")||A("colors")||A("color=true")||A("color=always"))&&(Z=1);function Ot(){if("FORCE_COLOR"in m)return m.FORCE_COLOR==="true"?1:m.FORCE_COLOR==="false"?0:m.FORCE_COLOR.length===0?1:Math.min(Number.parseInt(m.FORCE_COLOR,10),3)}i(Ot,"envForceColor");function Tt(e){return e===0?!1:{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}i(Tt,"translateLevel");function It(e,{streamIsTTY:t,sniffFlags:n=!0}={}){let o=Ot();o!==void 0&&(Z=o);let r=n?Z:o;if(r===0)return 0;if(n){if(A("color=16m")||A("color=full")||A("color=truecolor"))return 3;if(A("color=256"))return 2}if("TF_BUILD"in m&&"AGENT_NAME"in m)return 1;if(e&&!t&&r===void 0)return 0;let s=r||0;if(m.TERM==="dumb")return s;if(H.default.platform==="win32"){let l=ve.default.release().split(".");return Number(l[0])>=10&&Number(l[2])>=10586?Number(l[2])>=14931?3:2:1}if("CI"in m)return"GITHUB_ACTIONS"in m||"GITEA_ACTIONS"in m?3:["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","BUILDKITE","DRONE"].some(l=>l in m)||m.CI_NAME==="codeship"?1:s;if("TEAMCITY_VERSION"in m)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(m.TEAMCITY_VERSION)?1:0;if(m.COLORTERM==="truecolor"||m.TERM==="xterm-kitty")return 3;if("TERM_PROGRAM"in m){let l=Number.parseInt((m.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(m.TERM_PROGRAM){case"iTerm.app":return l>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(m.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(m.TERM)||"COLORTERM"in m?1:s}i(It,"_supportsColor");function Ee(e,t={}){let n=It(e,{streamIsTTY:e&&e.isTTY,...t});return Tt(n)}i(Ee,"createSupportsColor");var kt={stdout:Ee({isTTY:ne.default.isatty(1)}),stderr:Ee({isTTY:ne.default.isatty(2)})},Ae=kt;function Pe(e,t,n){let o=e.indexOf(t);if(o===-1)return e;let r=t.length,s=0,l="";do l+=e.slice(s,o)+t+n,s=o+r,o=e.indexOf(t,s);while(o!==-1);return l+=e.slice(s),l}i(Pe,"stringReplaceAll");function Re(e,t,n,o){let r=0,s="";do{let l=e[o-1]==="\r";s+=e.slice(r,l?o-1:o)+t+(l?`\r
`:`
`)+n,r=o+1,o=e.indexOf(`
`,r)}while(o!==-1);return s+=e.slice(r),s}i(Re,"stringEncaseCRLFWithFirstIndex");var{stdout:Oe,stderr:Te}=Ae,oe=Symbol("GENERATOR"),L=Symbol("STYLER"),Y=Symbol("IS_EMPTY"),Ie=["ansi","ansi","ansi256","ansi16m"],D=Object.create(null),$t=i((e,t={})=>{if(t.level&&!(Number.isInteger(t.level)&&t.level>=0&&t.level<=3))throw new Error("The `level` option should be an integer from 0 to 3");let n=Oe?Oe.level:0;e.level=t.level===void 0?n:t.level},"applyOptions"),se=class se{constructor(t){return ke(t)}};i(se,"Chalk");var J=se,ke=i(e=>{let t=i((...n)=>n.join(" "),"chalk");return $t(t,e),Object.setPrototypeOf(t,z.prototype),t},"chalkFactory");function z(e){return ke(e)}i(z,"createChalk");Object.setPrototypeOf(z.prototype,Function.prototype);for(let[e,t]of Object.entries(T))D[e]={get(){let n=q(this,ie(t.open,t.close,this[L]),this[Y]);return Object.defineProperty(this,e,{value:n}),n}};D.visible={get(){let e=q(this,this[L],!0);return Object.defineProperty(this,"visible",{value:e}),e}};var re=i((e,t,n,...o)=>e==="rgb"?t==="ansi16m"?T[n].ansi16m(...o):t==="ansi256"?T[n].ansi256(T.rgbToAnsi256(...o)):T[n].ansi(T.rgbToAnsi(...o)):e==="hex"?re("rgb",t,n,...T.hexToRgb(...o)):T[n][e](...o),"getModelAnsi"),jt=["rgb","hex","ansi256"];for(let e of jt){D[e]={get(){let{level:n}=this;return function(...o){let r=ie(re(e,Ie[n],"color",...o),T.color.close,this[L]);return q(this,r,this[Y])}}};let t="bg"+e[0].toUpperCase()+e.slice(1);D[t]={get(){let{level:n}=this;return function(...o){let r=ie(re(e,Ie[n],"bgColor",...o),T.bgColor.close,this[L]);return q(this,r,this[Y])}}}}var Bt=Object.defineProperties(()=>{},{...D,level:{enumerable:!0,get(){return this[oe].level},set(e){this[oe].level=e}}}),ie=i((e,t,n)=>{let o,r;return n===void 0?(o=e,r=t):(o=n.openAll+e,r=t+n.closeAll),{open:e,close:t,openAll:o,closeAll:r,parent:n}},"createStyler"),q=i((e,t,n)=>{let o=i((...r)=>Ft(o,r.length===1?""+r[0]:r.join(" ")),"builder");return Object.setPrototypeOf(o,Bt),o[oe]=e,o[L]=t,o[Y]=n,o},"createBuilder"),Ft=i((e,t)=>{if(e.level<=0||!t)return e[Y]?"":t;let n=e[L];if(n===void 0)return t;let{openAll:o,closeAll:r}=n;if(t.includes("\x1B"))for(;n!==void 0;)t=Pe(t,n.close,n.open),n=n.parent;let s=t.indexOf(`
`);return s!==-1&&(t=Re(t,r,o,s)),o+t+r},"applyStyle");Object.defineProperties(z.prototype,D);var fn=z(),gn=z({level:Te?Te.level:0});var C=new J;var hn=!!process.env.CI;async function Mt(...e){let{default:t}=await import("prompt-sync");return t({sigint:!0})(...e)}i(Mt,"prompt");function y(e,t,n){console.log(n!==void 0&&n!==t?`${C.yellow(`${e}:`.padEnd(20))}${C.magenta(t)}`:`${`${e}:`.padEnd(20)}${t}`)}i(y,"logVariable");function S(e){console.log(`[INFO] ${e}`)}i(S,"logInfo");function $e(e){process.env.VERBOSE&&console.log(`[VERBOSE] ${e}`)}i($e,"logVerbose");function j(e){console.log(C.red(`[WARNING] ${e}`))}i(j,"logWarning");function P(e,t){e instanceof Error?(console.log(C.red(`[ERROR] ${t||e.message}`)),process.env.VERBOSE&&console.error(e)):console.log(C.red(`[ERROR] ${e}`))}i(P,"logError");function R(e){console.log(C.bgYellow(`==== ${e} ====`))}i(R,"logBanner");async function je(e){return await Mt(e,"yes",{})==="yes"}i(je,"confirm");function B(){return"4.0.0"}i(B,"getVersion");var Pn=require("reflect-metadata"),Ge=w(require("path"),1);var Be=w(require("fs"),1),Fe=w(require("path"),1);async function ae(e){let{default:t}=await import("simple-git");return t(e)}i(ae,"simpleGit");async function Nt(e){try{return(await(await ae(e)).raw("--version")).trim()}catch{return}}i(Nt,"getGitVersion");async function Gt(e){try{return(await ae(e)).raw("status","--porcelain")}catch(t){console.log(t);return}}i(Gt,"getGitChanges");async function Me(e){return(await(await ae(e)).raw("rev-parse","HEAD")).trim()}i(Me,"getSha");async function Ne(e,t){if(Be.default.existsSync(Fe.default.join(e,".git"))){y("Git Bin Version",await Nt(e));let n=await Gt(e);n!==""&&(t?j("Changes detected in .git"):(n===void 0?P("Error detecting Git"):(R("Detected Changes in Git - Stage must be clean to build!"),console.log(n)),process.exit(1)))}}i(Ne,"detectGitChanges");var le=Symbol("options_key");function b(e){return(t,n)=>{var o,r;if(e!=null){let s={...Reflect.getMetadata(le,t)||{},[n]:{...e,describe:e.envAlias?`${e.describe||""} [${e.envAlias}]`:e.describe,type:e.type||((r=(o=Reflect.getMetadata("design:type",t,n))==null?void 0:o.name)==null?void 0:r.toLowerCase())}};Reflect.defineMetadata(le,s,t)}}}i(b,"YargOption");function Le(e){let t=Reflect.getMetadata(le,e.prototype);if(!t)throw new Error(`Options for ${e.name} were not defined`);return t}i(Le,"getYargsOption");function _(e){return async t=>t.options(Lt(e)).middleware(async n=>await Dt(e,n),!0)}i(_,"getBuilder");function Lt(e){return Object.entries(Le(e)).reduce((t,[n,o])=>(t[n]=Object.fromEntries(Object.entries(o).filter(([r])=>!["envAlias","default"].includes(r))),t),{})}i(Lt,"getYargsOptions");async function Dt(e,t){let n=new e;if(n.pwd=Ge.default.resolve(t.pwd||process.env.PWD||process.cwd()),!n.pwd)throw new Error("No PWD given");n.release||(n.release=process.env.RELEASE||process.env.RELEASE_SHA||await Me(n.pwd));for(let[o,r]of Object.entries(Le(e)))["pwd","release"].includes(o)||(n[o]=(t[o]||r.envAlias&&process.env[r.envAlias])??r.default);return n}i(Dt,"loadYargsConfig");var x=require("zod"),ge=w(require("lodash.merge"),1),We=require("cosmiconfig");var _t=w(require("lodash.merge"),1),U=require("@aws-sdk/client-ssm");var De=require("@aws-sdk/credential-providers");function V(e){return(0,De.fromNodeProviderChain)({clientConfig:{region:e.region}})}i(V,"getCredentials");function Vt(e){return new U.SSMClient({credentials:V(e),region:e.region})}i(Vt,"getSSMInstance");var Wt=/arn:aws:ssm:(?<region>[^:]+)?:(?<accountId>\d+)?:parameter\/(?<path>.*)/;async function _e(e){var r,s;let t=e.name.match(Wt);if(!((r=t==null?void 0:t.groups)!=null&&r.path))throw new Error("Could not parse parameter arn");let n,o=Vt({region:e.region});try{n=await o.send(new U.GetParameterCommand({Name:`/${t.groups.path}`,WithDecryption:!0}))}catch(l){throw new Error(`Could not get parameter ${e.name}`,{cause:l})}if(!((s=n.Parameter)!=null&&s.Value))throw new Error("Could not get parameter");return n.Parameter.Value}i(_e,"getSSMParameter");var Yt=x.z.object({name:x.z.string(),treeFrom:x.z.string().optional(),valueFrom:x.z.string().optional(),objectFrom:x.z.string().optional(),configFrom:x.z.string().optional(),config:x.z.any().optional(),value:x.z.string().optional()}).refine(e=>[e.treeFrom,e.valueFrom,e.value,e.configFrom,e.objectFrom].filter(t=>t!==void 0).length===1,{message:"Exactly one of treeFrom, valueFrom, or value must be specified"}),Ve=x.z.object({name:x.z.string().optional(),destination:x.z.string(),values:x.z.array(Yt)}),Ye=x.z.union([Ve.extend({name:x.z.string().optional()}),Ve.array()]).transform(e=>Array.isArray(e)?e:[{name:"default",...e}]);async function W(e,t,n,o,r=!0){let s=await ze(e,t,n,r),l=o.safeParse(s);if(!l.success){for(let c of l.error.errors)if(c.code==="invalid_union")for(let a of c.unionErrors){let g=[];for(let f of a.issues)g.push(`'${f.path.join(".")}' => ${f.message}`);P(`Config conditional error: ${g.join(" & ")}`)}else P(`Config error at '${c.path.join(".")}': ${c.message}`);process.exit(1)}return l.data}i(W,"safeLoadConfig");async function ze(e,t,n,o=!0){let r={},s=!1;for(let l of[`${e}`,`${n}.${e}`,`${n}.${e}.local`]){let{search:c}=(0,We.cosmiconfigSync)(e,{searchPlaces:[`${l}.json`,`${l}.yml`],stopDir:t}),a;try{a=c(`${t}/.config`)}catch(g){console.error(g)}a&&!a.isEmpty&&($e(`Loaded ${a.filepath}`),r=(0,ge.default)(r,a.config),s=!0)}if(!s&&!o)throw new Error(`Could not find config '${e}' for stage ${n}`);return r}i(ze,"loadConfig");async function Ue({values:e},t,n,o){let r={};for(let{name:s,treeFrom:l,valueFrom:c,configFrom:a,config:g,objectFrom:f,value:E}of e){let v=r,d;if(E)d=E;else if(c)d=await ce(c,{...t,stage:o});else if(f)d=await ce(f,{...t,stage:o}),d=JSON.parse(d);else{if(l)throw new Error("treeFrom is not supported yet");if(a){let k=await ze(a,n,o,!1);d=await fe(k,{...t,stage:o})}else if(t)d=await fe(g,{...t,stage:o});else throw new Error("Exactly one of treeFrom, valueFrom, or value must be specified")}if(d!==void 0)if(s==="@"){if(typeof d!="object")throw new Error(`Cannot set root value to "${d}"`);r=(0,ge.default)(r,d)}else{let k=s.split("__");for(;k.length>1;){let G=k.shift();if(v[G]||(v[G]={}),typeof v[G]!="object")throw new Error(`Cannot create tree path at ${s}`);v=v[G]}v[k[0]]=d}}return r}i(Ue,"resolveZeConfigItem");async function ce(e,t,n="@"){if(e.startsWith("arn:aws:ssm")){if(!t.awsRegion)throw new Error(`Cannot resolve resource ${e} at ${n} without awsRegion`);return await _e({region:t.awsRegion,name:e})}if(e.startsWith("env:"))return process.env[e.slice(4)];if(e.startsWith("func:"))switch(e.slice(5)){case"timestamp":return new Date().toISOString();case"stage":return t.stage;case"release":return t.release;default:throw new Error(`Unknown function '${e}' at '${n}'`)}throw new Error(`Cannot resolve resource '${e}' at '${n}'`)}i(ce,"resolveResource");async function fe(e,t,n){if(e!=null){if(typeof e=="object")for(let[o,r]of Object.entries(e))e[o]=await fe(r,t,`${n}.${o}`);else if(typeof e=="string"&&e.startsWith("${")&&e.endsWith("}"))return await ce(e.slice(2,-1),t)}return e}i(fe,"resolveConfig");var Q=require("zod"),ue=w(require("path"),1),Ke=w(require("fs"),1),Ze=require("js-yaml");async function He(e){var n;let t=await W("spa-deploy",e.pwd,e.stage,Q.z.object({inject:Ye,aws:Q.z.object({region:Q.z.string().optional()}).optional()}),!1);for(let o of t.inject){if(e.target&&o.name!==e.target)continue;let r=await Ue(o,{awsRegion:(n=t.aws)==null?void 0:n.region,release:e.release},e.pwd,e.stage),{destination:s}=o,l=zt(ue.default.basename(s),r),c=ue.default.join(e.pwd,s);l&&(console.log(`Writing ${c}`),Ke.default.writeFileSync(c,l))}}i(He,"inject");function zt(e,t){if(e.endsWith(".json"))return JSON.stringify(t,null,2);if(e.endsWith(".yml")||e.endsWith(".yaml"))return(0,Ze.dump)(t);if(e.endsWith(".env")||e.startsWith(".env")){let n=[];for(let[o,r]of Object.entries(t))typeof r=="string"?n.push(`${o}=${r}`):n.push(`${o}=${JSON.stringify(r)}`);return n.join(`
`)}else throw new Error(`Unknown destination file type: ${e}`)}i(zt,"generate");var F=class F{pwd;stage;release;verbose;target};i(F,"InjectOptions"),h([b({envAlias:"PWD",demandOption:!0})],F.prototype,"pwd",2),h([b({envAlias:"STAGE",demandOption:!0})],F.prototype,"stage",2),h([b({envAlias:"RELEASE",demandOption:!0})],F.prototype,"release",2),h([b({envAlias:"VERBOSE",default:!1})],F.prototype,"verbose",2),h([b({default:!1})],F.prototype,"target",2);var de=F,Je={command:"inject [target]",describe:"Inject config into the app",builder:_(de),handler:async e=>{let t=await e;return t.verbose&&(R(`SPA Deploy ${B()}`),y("nodejs",process.version),y("pwd",t.pwd),y("release",t.release),y("stage",t.stage)),He({pwd:t.pwd,stage:t.stage,release:t.release,target:t.target,verbose:t.verbose})}};var u=require("zod"),ut=w(require("path"),1),dt=w(require("fs"),1);var X=require("@aws-sdk/client-cloudfront");function Ut(e){let t=e.endpoint||process.env.AWS_CLOUDFRONT_ENDPOINT;return new X.CloudFrontClient({credentials:V({region:e.region}),region:e.region,endpoint:t})}i(Ut,"getCloudfrontClientInstance");function qe(e){let{items:t}=e;return[...t.reduce((n,o)=>(o.invalidate&&n.push(`/${o.remote.key}`),n),[])]}i(qe,"prepareCloudfrontInvalidation");async function ee(e,t,n){for(let o of t){let r=Ut({region:n});S(`Invalidating ${o}`),await r.send(new X.CreateInvalidationCommand({DistributionId:o,InvalidationBatch:{CallerReference:new Date().toISOString(),Paths:{Quantity:e.length,Items:e}}}))}}i(ee,"executeCloudfrontInvalidation");var Qe=w(require("fast-glob"),1),Xe=require("crypto"),pe=w(require("fs"),1),et=w(require("path"),1);var tt={Unknown:C.yellow,Unchanged:C.reset,Ignore:C.reset,Delete:C.red,Update:C.magenta,Create:C.magenta};async function*nt(e){for await(let t of Qe.default.globSync(e.includeGlob||["**"],{onlyFiles:!0,ignore:e.ignoreGlob,cwd:e.path,unique:!0})){let n=et.default.join(e.path,t);yield{path:n,key:t,size:pe.default.statSync(n).size,hash:await Kt(n)}}}i(nt,"scanLocal");async function Kt(e){return new Promise((t,n)=>{let o=(0,Xe.createHash)("md5"),r=pe.default.createReadStream(e);r.on("error",s=>n(s)),r.on("data",s=>o.update(s)),r.on("end",()=>t(o.digest("hex")))})}i(Kt,"fileMd5");var M=require("@aws-sdk/client-s3"),ot=require("mime-types"),rt=w(require("micromatch"),1),it=w(require("fs"),1);function st(e){let t=e.endpoint||process.env.AWS_S3_ENDPOINT;return new M.S3Client({credentials:V({region:e.region}),region:e.region,...t?{forcePathStyle:!0,endpoint:t}:{}})}i(st,"getS3ClientInstance");async function*Ht(e,t){for await(let n of(0,M.paginateListObjectsV2)({client:e},{Bucket:t.bucket,Prefix:t.prefix}))if(n.Contents)for(let o of n.Contents)yield{Key:o.Key,LastModified:o.LastModified,ETag:o.ETag,Size:o.Size}}i(Ht,"scanS3Files");function at(e,t=!0,n=!1){let o=[];for(let r of e.items){let{key:s,action:l,invalidate:c,cache:a,local:g,contentType:f,data:E}=r;if(!n&&l=="Unchanged")continue;if(!l)throw new Error(`Action not defined for ${s}`);let v=[tt[l](l.padEnd(9," ")),[c?C.magenta("Invalidate"):"          ",a?l=="Unchanged"?"Cached":"Cache":"     ",E!==void 0?"DATA  ":"      "].join("	"),` ${s} `,g?`(${g.size}b ${f??""})`:""];o.push(v.join(""))}return t&&console.log(o.join(`
`)),o.join(`
`)}i(at,"printS3SyncPlan");async function lt(e,t){var l,c;let n={};for await(let a of nt(e)){let g={local:a,contentDisposition:"inline",contentType:(0,ot.lookup)(a.path)||"application/octet-stream",action:"Create",acl:t.acl};t.invalidateGlob&&rt.default.isMatch(a.key,t.invalidateGlob)?n[a.key]={key:a.key,...g,cacheControl:"public, must-revalidate",invalidate:!1,cache:!1,...n[a.key]?n[a.key]:{}}:n[a.key]={key:a.key,...g,cacheControl:"max-age=2628000, public",invalidate:!1,cache:!0,...n[a.key]?n[a.key]:{}}}let o=st({region:t.region,endpoint:t.endpoint});for await(let a of Ht(o,{bucket:t.bucket,prefix:t.prefix})){let g=t.purge?"Delete":"Unknown";if(!a.Key)throw new Error(`File Key not defined for ${JSON.stringify(a)}`);let f=a.Key;if(!a.ETag)throw new Error(`File Etag not defined for ${JSON.stringify(a)}`);n[f]={key:f,remote:{key:f,lastModified:a.LastModified,eTag:a.ETag.replace(/"/g,""),size:a.Size},action:g,...n[f]?n[f]:{}},n[f].local&&(!t.force&&((l=n[f].local)==null?void 0:l.hash)===((c=n[f].remote)==null?void 0:c.eTag)?n[f].action="Unchanged":(n[f].invalidate=!0,n[f].action="Update"))}let r={Unknown:0,Ignore:1,Unchanged:2,Create:3,Update:4,Delete:5},s=Object.values(n);return s.sort((a,g)=>r[a.action]>r[g.action]?1:r[a.action]<r[g.action]||a.cache&&!g.cache?-1:!a.cache&&g.cache?1:0),{items:s,region:t.region,bucket:t.bucket,endpoint:t.endpoint}}i(lt,"prepareS3SyncPlan");async function ct(e){let{items:t,region:n,endpoint:o,bucket:r}=e,s=st({region:n,endpoint:o});for(let l of t){let{key:c,action:a,cacheControl:g,contentType:f,contentDisposition:E,local:v,data:d}=l;switch(a){case"Create":case"Update":{S(`Uploading ${c}`),await s.send(new M.PutObjectCommand({Bucket:r,Key:c,CacheControl:g,ContentType:f,ContentDisposition:E,Body:d!==void 0?d:it.default.readFileSync(v.path)}));break}case"Delete":{S(`Deleting ${c}`),await s.send(new M.DeleteObjectCommand({Bucket:r,Key:c}));break}default:break}}}i(ct,"executeS3SyncPlan");var $=require("zod");var ft=i(function(e){return e==null?[]:Array.isArray(e)?e:[e]},"toArray"),te=$.z.object({region:$.z.string().optional(),invalidatePaths:$.z.union([$.z.string(),$.z.string().array()]).optional().transform(ft),distributionId:$.z.union([$.z.string(),$.z.string().array()]).optional().transform(ft)});var me=i(function(e){return e==null?[]:Array.isArray(e)?e:[e]},"toArray"),gt=u.z.object({name:u.z.string(),buildPath:u.z.string().optional().default("dist").describe("Path to SPA build"),includeGlob:u.z.union([u.z.string(),u.z.string().array()]).transform(me).describe("Include only these files, defaults to all files in buildPath").optional(),ignoreGlob:u.z.union([u.z.string(),u.z.string().array()]).transform(me).describe("Ignore these files, has priority over include").optional(),s3:u.z.object({region:u.z.string().optional(),bucket:u.z.string(),prefix:u.z.string().describe("Prefix path used on S3").optional(),endpoint:u.z.string().describe("AWS services endpoint").optional(),force:u.z.boolean().describe("Replace all files unconditionally").optional(),purge:u.z.boolean().describe("Remove all unknown files from S3").optional(),invalidateGlob:u.z.union([u.z.string(),u.z.string().array()]).transform(me).describe("Do not cache these files and invalidate them on deploy").optional(),acl:u.z.string().optional()}).optional(),cloudfront:te.optional()}),Jt=u.z.union([gt.extend({name:u.z.string().optional()}),gt.array()]).transform(e=>Array.isArray(e)?e:[e]);async function pt(e){var n,o,r,s,l,c;let t=await W("spa-deploy",e.pwd,e.stage,u.z.object({deploy:Jt,aws:u.z.object({region:u.z.string().optional(),accountId:u.z.string().optional(),endpoint:u.z.string().optional()}).optional()}),!1);for(let a of t.deploy){if(e.target&&a.name!==e.target)continue;S(`Deploying ${a.name||""}...`);let g=ut.default.join(e.pwd,a.buildPath);y("deploy__buildPath",g),dt.default.lstatSync(g).isDirectory()||(P(`Build path ${g} is not a directory.`),process.exit(1));let f;if(a.s3){let d=a.s3.endpoint||((n=t.aws)==null?void 0:n.endpoint);d&&y("deploy__s3__endpoint",d);let k=a.s3.region||((o=t.aws)==null?void 0:o.region);y("deploy__s3__region",k),k||(P("AWS Region is not set"),process.exit(1));let G=a.s3.bucket;y("deploy__s3__bucket",G),G||(P("S3 Deploy Bucket is not set"),process.exit(1));let be=a.s3.prefix;be&&y("deploy__s3__prefix",be),f=await lt({path:g,includeGlob:a.includeGlob,ignoreGlob:a.ignoreGlob},{region:k,bucket:a.s3.bucket,endpoint:d,prefix:a.s3.prefix,force:a.s3.force||e.force,purge:a.s3.purge||e.purge,invalidateGlob:a.s3.invalidateGlob,acl:a.s3.acl}),R("S3 Sync Plan"),at(f,!0,!!e.verbose)}if(!f||!f.items.some(d=>["Create","Update","Delete"].includes(d.action))){S("No files to deploy");continue}let E=[],v=((r=a.cloudfront)==null?void 0:r.distributionId)||[];if(a.cloudfront&&f&&(E=qe(f)),(l=(s=a.cloudfront)==null?void 0:s.invalidatePaths)!=null&&l.length&&(E=[...E,...a.cloudfront.invalidatePaths]),E.length>0){R("Cloudfront invalidations");for(let d of E)console.log(d);v.length<1&&j("Cloudfront distributionId is not set")}if(!e.ci&&!await je("Press enter to deploy...")){S("Canceled");return}if(await ct(f),a.cloudfront){let d=a.cloudfront.region||((c=t.aws)==null?void 0:c.region);if(y("deploy__cloudfront__region",d),!d){j("AWS Region is not set");continue}E.length>0&&v.length>0&&await ee(E,v,d)}}}i(pt,"deploy");var O=class O{pwd;stage;release;verbose;target;ci;ignoreGitChanges;purge;force};i(O,"DeployOptions"),h([b({envAlias:"PWD",demandOption:!0})],O.prototype,"pwd",2),h([b({envAlias:"STAGE",demandOption:!0})],O.prototype,"stage",2),h([b({envAlias:"RELEASE",demandOption:!0})],O.prototype,"release",2),h([b({envAlias:"VERBOSE",default:!1})],O.prototype,"verbose",2),h([b({default:!1})],O.prototype,"target",2),h([b({envAlias:"CI"})],O.prototype,"ci",2),h([b({envAlias:"IGNORE_GIT_CHANGES"})],O.prototype,"ignoreGitChanges",2),h([b({describe:"Remove all undefined files from S3"})],O.prototype,"purge",2),h([b({describe:"Replace all files even if not changed"})],O.prototype,"force",2);var ye=O,mt={command:"deploy [target]",describe:"Deploy SPA to target",builder:_(ye),handler:async e=>{let t=await e;return t.verbose&&(R(`SPA Deploy ${B()}`),y("nodejs",process.version),y("pwd",t.pwd),y("release",t.release),y("stage",t.stage)),t.ci?t.verbose&&S("Running Non-Interactively"):await Ne(t.pwd,t.ignoreGitChanges),pt({pwd:t.pwd,stage:t.stage,release:t.release,target:t.target,verbose:t.verbose,purge:t.purge,force:t.force})}};var I=require("zod");var N=class N{release;pwd;stage;target;verbose};i(N,"InvalidateOptions"),h([b({envAlias:"RELEASE",demandOption:!0})],N.prototype,"release",2),h([b({envAlias:"PWD",demandOption:!0})],N.prototype,"pwd",2),h([b({envAlias:"STAGE",demandOption:!0})],N.prototype,"stage",2),h([b({default:!1})],N.prototype,"target",2),h([b({envAlias:"VERBOSE",default:!1})],N.prototype,"verbose",2);var he=N,yt={command:"invalidate [target]",describe:"Deploy SPA to target",builder:_(he),handler:async e=>{var r;let t=await e;t.verbose&&(R(`SPA Deploy ${B()}`),y("nodejs",process.version),y("pwd",t.pwd),y("stage",t.stage));let n=I.z.object({name:I.z.string(),cloudfront:te}),o=await W("spa-deploy",t.pwd,t.stage,I.z.object({deploy:I.z.union([n.extend({name:I.z.string().optional()}),n.array()]).transform(s=>Array.isArray(s)?s:[s]),aws:I.z.object({region:I.z.string().optional(),accountId:I.z.string().optional(),endpoint:I.z.string().optional()}).optional()}),!1);for(let s of o.deploy){if(t.target&&s.name!==t.target||!s.cloudfront)continue;let l=s.cloudfront.region||((r=o.aws)==null?void 0:r.region);if(!l){j("Missing region");continue}let c=s.cloudfront.invalidatePaths||[],a=s.cloudfront.distributionId||[];if(c.length>0){R("Cloudfront invalidations");for(let g of c)console.log(g);a.length<1&&j("Cloudfront distributionId is not set"),await ee(c,a,l)}else S("No cloudfront invalidations")}}};(0,ht.default)((0,bt.hideBin)(process.argv)).version(B()||"unknown").scriptName("spa-deploy").command(Je).command(mt).command(yt).help().demandCommand(1).strictCommands(!0).showHelpOnFail(!0).fail((e,t)=>{e&&P(e),t&&P(t),S("Use '--help' for more info"),process.exit(1)}).parse();

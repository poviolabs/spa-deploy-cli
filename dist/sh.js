#!/usr/bin/env node
import { createRequire } from 'module'; const require = createRequire(import.meta.url);import * as url from 'url';const __dirname = url.fileURLToPath(new URL('.', import.meta.url));
"use strict";var Ie=Object.create;var I=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var Me=Object.getOwnPropertyNames;var Fe=Object.getPrototypeOf,Be=Object.prototype.hasOwnProperty;var s=(e,r)=>I(e,"name",{value:r,configurable:!0});var Ne=(e,r,t,o)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of Me(r))!Be.call(e,n)&&n!==t&&I(e,n,{get:()=>r[n],enumerable:!(o=Q(r,n))||o.enumerable});return e};var d=(e,r,t)=>(t=e!=null?Ie(Fe(e)):{},Ne(r||!e||!e.__esModule?I(t,"default",{value:e,enumerable:!0}):t,e));var b=(e,r,t,o)=>{for(var n=o>1?void 0:o?Q(r,t):r,i=e.length-1,a;i>=0;i--)(a=e[i])&&(n=(o?a(r,t,n):a(n))||n);return o&&n&&I(r,t,n),n};var $e=d(require("yargs"),1),Pe=require("yargs/helpers");var f=require("zod"),Z=d(require("lodash.merge"),1),we=require("cosmiconfig");var X=s((e=0)=>r=>`\x1B[${r+e}m`,"wrapAnsi16"),ee=s((e=0)=>r=>`\x1B[${38+e};5;${r}m`,"wrapAnsi256"),re=s((e=0)=>(r,t,o)=>`\x1B[${38+e};2;${r};${t};${o}m`,"wrapAnsi16m"),l={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],gray:[90,39],grey:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgGray:[100,49],bgGrey:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}},nr=Object.keys(l.modifier),je=Object.keys(l.color),ke=Object.keys(l.bgColor),sr=[...je,...ke];function Le(){let e=new Map;for(let[r,t]of Object.entries(l)){for(let[o,n]of Object.entries(t))l[o]={open:`\x1B[${n[0]}m`,close:`\x1B[${n[1]}m`},t[o]=l[o],e.set(n[0],n[1]);Object.defineProperty(l,r,{value:t,enumerable:!1})}return Object.defineProperty(l,"codes",{value:e,enumerable:!1}),l.color.close="\x1B[39m",l.bgColor.close="\x1B[49m",l.color.ansi=X(),l.color.ansi256=ee(),l.color.ansi16m=re(),l.bgColor.ansi=X(10),l.bgColor.ansi256=ee(10),l.bgColor.ansi16m=re(10),Object.defineProperties(l,{rgbToAnsi256:{value(r,t,o){return r===t&&t===o?r<8?16:r>248?231:Math.round((r-8)/247*24)+232:16+36*Math.round(r/255*5)+6*Math.round(t/255*5)+Math.round(o/255*5)},enumerable:!1},hexToRgb:{value(r){let t=/[a-f\d]{6}|[a-f\d]{3}/i.exec(r.toString(16));if(!t)return[0,0,0];let[o]=t;o.length===3&&(o=[...o].map(i=>i+i).join(""));let n=Number.parseInt(o,16);return[n>>16&255,n>>8&255,n&255]},enumerable:!1},hexToAnsi256:{value:r=>l.rgbToAnsi256(...l.hexToRgb(r)),enumerable:!1},ansi256ToAnsi:{value(r){if(r<8)return 30+r;if(r<16)return 90+(r-8);let t,o,n;if(r>=232)t=((r-232)*10+8)/255,o=t,n=t;else{r-=16;let u=r%36;t=Math.floor(r/36)/5,o=Math.floor(u/6)/5,n=u%6/5}let i=Math.max(t,o,n)*2;if(i===0)return 30;let a=30+(Math.round(n)<<2|Math.round(o)<<1|Math.round(t));return i===2&&(a+=60),a},enumerable:!1},rgbToAnsi:{value:(r,t,o)=>l.ansi256ToAnsi(l.rgbToAnsi256(r,t,o)),enumerable:!1},hexToAnsi:{value:r=>l.ansi256ToAnsi(l.hexToAnsi256(r)),enumerable:!1}}),l}s(Le,"assembleStyles");var _e=Le(),m=_e;var F=d(require("process"),1),oe=d(require("os"),1),_=d(require("tty"),1);function p(e,r=globalThis.Deno?globalThis.Deno.args:F.default.argv){let t=e.startsWith("-")?"":e.length===1?"-":"--",o=r.indexOf(t+e),n=r.indexOf("--");return o!==-1&&(n===-1||o<n)}s(p,"hasFlag");var{env:c}=F.default,M;p("no-color")||p("no-colors")||p("color=false")||p("color=never")?M=0:(p("color")||p("colors")||p("color=true")||p("color=always"))&&(M=1);function Ge(){if("FORCE_COLOR"in c)return c.FORCE_COLOR==="true"?1:c.FORCE_COLOR==="false"?0:c.FORCE_COLOR.length===0?1:Math.min(Number.parseInt(c.FORCE_COLOR,10),3)}s(Ge,"envForceColor");function Ve(e){return e===0?!1:{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}s(Ve,"translateLevel");function We(e,{streamIsTTY:r,sniffFlags:t=!0}={}){let o=Ge();o!==void 0&&(M=o);let n=t?M:o;if(n===0)return 0;if(t){if(p("color=16m")||p("color=full")||p("color=truecolor"))return 3;if(p("color=256"))return 2}if("TF_BUILD"in c&&"AGENT_NAME"in c)return 1;if(e&&!r&&n===void 0)return 0;let i=n||0;if(c.TERM==="dumb")return i;if(F.default.platform==="win32"){let a=oe.default.release().split(".");return Number(a[0])>=10&&Number(a[2])>=10586?Number(a[2])>=14931?3:2:1}if("CI"in c)return"GITHUB_ACTIONS"in c||"GITEA_ACTIONS"in c?3:["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","BUILDKITE","DRONE"].some(a=>a in c)||c.CI_NAME==="codeship"?1:i;if("TEAMCITY_VERSION"in c)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(c.TEAMCITY_VERSION)?1:0;if(c.COLORTERM==="truecolor"||c.TERM==="xterm-kitty")return 3;if("TERM_PROGRAM"in c){let a=Number.parseInt((c.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(c.TERM_PROGRAM){case"iTerm.app":return a>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(c.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(c.TERM)||"COLORTERM"in c?1:i}s(We,"_supportsColor");function te(e,r={}){let t=We(e,{streamIsTTY:e&&e.isTTY,...r});return Ve(t)}s(te,"createSupportsColor");var Ye={stdout:te({isTTY:_.default.isatty(1)}),stderr:te({isTTY:_.default.isatty(2)})},ne=Ye;function se(e,r,t){let o=e.indexOf(r);if(o===-1)return e;let n=r.length,i=0,a="";do a+=e.slice(i,o)+r+t,i=o+n,o=e.indexOf(r,i);while(o!==-1);return a+=e.slice(i),a}s(se,"stringReplaceAll");function ie(e,r,t,o){let n=0,i="";do{let a=e[o-1]==="\r";i+=e.slice(n,a?o-1:o)+r+(a?`\r
`:`
`)+t,n=o+1,o=e.indexOf(`
`,n)}while(o!==-1);return i+=e.slice(n),i}s(ie,"stringEncaseCRLFWithFirstIndex");var{stdout:ae,stderr:le}=ne,G=Symbol("GENERATOR"),C=Symbol("STYLER"),T=Symbol("IS_EMPTY"),ce=["ansi","ansi","ansi256","ansi16m"],E=Object.create(null),De=s((e,r={})=>{if(r.level&&!(Number.isInteger(r.level)&&r.level>=0&&r.level<=3))throw new Error("The `level` option should be an integer from 0 to 3");let t=ae?ae.level:0;e.level=r.level===void 0?t:r.level},"applyOptions"),Y=class Y{constructor(r){return fe(r)}};s(Y,"Chalk");var B=Y,fe=s(e=>{let r=s((...t)=>t.join(" "),"chalk");return De(r,e),Object.setPrototypeOf(r,S.prototype),r},"chalkFactory");function S(e){return fe(e)}s(S,"createChalk");Object.setPrototypeOf(S.prototype,Function.prototype);for(let[e,r]of Object.entries(m))E[e]={get(){let t=N(this,W(r.open,r.close,this[C]),this[T]);return Object.defineProperty(this,e,{value:t}),t}};E.visible={get(){let e=N(this,this[C],!0);return Object.defineProperty(this,"visible",{value:e}),e}};var V=s((e,r,t,...o)=>e==="rgb"?r==="ansi16m"?m[t].ansi16m(...o):r==="ansi256"?m[t].ansi256(m.rgbToAnsi256(...o)):m[t].ansi(m.rgbToAnsi(...o)):e==="hex"?V("rgb",r,t,...m.hexToRgb(...o)):m[t][e](...o),"getModelAnsi"),Ue=["rgb","hex","ansi256"];for(let e of Ue){E[e]={get(){let{level:t}=this;return function(...o){let n=W(V(e,ce[t],"color",...o),m.color.close,this[C]);return N(this,n,this[T])}}};let r="bg"+e[0].toUpperCase()+e.slice(1);E[r]={get(){let{level:t}=this;return function(...o){let n=W(V(e,ce[t],"bgColor",...o),m.bgColor.close,this[C]);return N(this,n,this[T])}}}}var Ze=Object.defineProperties(()=>{},{...E,level:{enumerable:!0,get(){return this[G].level},set(e){this[G].level=e}}}),W=s((e,r,t)=>{let o,n;return t===void 0?(o=e,n=r):(o=t.openAll+e,n=r+t.closeAll),{open:e,close:r,openAll:o,closeAll:n,parent:t}},"createStyler"),N=s((e,r,t)=>{let o=s((...n)=>ze(o,n.length===1?""+n[0]:n.join(" ")),"builder");return Object.setPrototypeOf(o,Ze),o[G]=e,o[C]=r,o[T]=t,o},"createBuilder"),ze=s((e,r)=>{if(e.level<=0||!r)return e[T]?"":r;let t=e[C];if(t===void 0)return r;let{openAll:o,closeAll:n}=t;if(r.includes("\x1B"))for(;t!==void 0;)r=se(r,t.close,t.open),t=t.parent;let i=r.indexOf(`
`);return i!==-1&&(r=ie(r,n,o,i)),o+r+n},"applyStyle");Object.defineProperties(S.prototype,E);var dr=S(),hr=S({level:le?le.level:0});var A=new B;var Or=!!process.env.CI;function O(e,r,t){console.log(t!==void 0&&t!==r?`${A.yellow(`${e}:`.padEnd(20))}${A.magenta(r)}`:`${`${e}:`.padEnd(20)}${r}`)}s(O,"logVariable");function ue(e){console.log(`[INFO] ${e}`)}s(ue,"logInfo");function ge(e){process.env.VERBOSE&&console.log(`[VERBOSE] ${e}`)}s(ge,"logVerbose");function v(e,r){e instanceof Error?(console.log(A.red(`[ERROR] ${r||e.message}`)),process.env.VERBOSE&&console.error(e)):console.log(A.red(`[ERROR] ${e}`))}s(v,"logError");var He=d(require("lodash.merge"),1),$=require("@aws-sdk/client-ssm");var pe=require("@aws-sdk/credential-providers");function me(e){return(0,pe.fromNodeProviderChain)({clientConfig:{region:e.region}})}s(me,"getCredentials");function Ke(e){return new $.SSMClient({credentials:me(e),region:e.region})}s(Ke,"getSSMInstance");var Je=/arn:aws:ssm:(?<region>[^:]+)?:(?<accountId>\d+)?:parameter\/(?<path>.*)/;async function de(e){var n,i;let r=e.name.match(Je);if(!((n=r==null?void 0:r.groups)!=null&&n.path))throw new Error("Could not parse parameter arn");let t,o=Ke({region:e.region});try{t=await o.send(new $.GetParameterCommand({Name:`/${r.groups.path}`,WithDecryption:!0}))}catch(a){throw new Error(`Could not get parameter ${e.name}`,{cause:a})}if(!((i=t.Parameter)!=null&&i.Value))throw new Error("Could not get parameter");return t.Parameter.Value}s(de,"getSSMParameter");var qe=f.z.object({name:f.z.string(),treeFrom:f.z.string().optional(),valueFrom:f.z.string().optional(),objectFrom:f.z.string().optional(),configFrom:f.z.string().optional(),config:f.z.any().optional(),value:f.z.string().optional()}).refine(e=>[e.treeFrom,e.valueFrom,e.value,e.configFrom,e.objectFrom].filter(r=>r!==void 0).length===1,{message:"Exactly one of treeFrom, valueFrom, or value must be specified"}),he=f.z.object({name:f.z.string().optional(),destination:f.z.string(),values:f.z.array(qe)}),ye=f.z.union([he.extend({name:f.z.string().optional()}),he.array()]).transform(e=>Array.isArray(e)?e:[{name:"default",...e}]);async function be(e,r,t,o){let n=await Ce(e,r,t),i=o.safeParse(n);if(!i.success){let a=[];for(let u of i.error.errors)a.push(`${u.path.join(".")}: ${u.message}`);v(`Invalid config: ${a.join(";")}`),process.exit(1)}return i.data}s(be,"safeLoadConfig");async function Ce(e,r,t,o=!0){let n={},i=!1;for(let a of[`${e}`,`${t}.${e}`,`${t}.${e}.local`]){let{search:u}=(0,we.cosmiconfigSync)(e,{searchPlaces:[`${a}.json`,`${a}.yml`],stopDir:r}),h;try{h=u(`${r}/.config`)}catch(L){console.error(L)}h&&!h.isEmpty&&(ge(`Loaded ${h.filepath}`),n=(0,Z.default)(n,h.config),i=!0)}if(!i&&!o)throw new Error(`Could not find config '${e}' for stage ${t}`);return n}s(Ce,"loadConfig");async function Ee({values:e},r,t,o){let n={};for(let{name:i,treeFrom:a,valueFrom:u,configFrom:h,config:L,objectFrom:J,value:q}of e){let y=n,g;if(q)g=q;else if(u)g=await D(u,{...r,stage:o});else if(J)g=await D(J,{...r,stage:o}),g=JSON.parse(g);else{if(a)throw new Error("treeFrom is not supported yet");if(h){let R=await Ce(h,t,o,!1);g=await U(R,{...r,stage:o})}else if(r)g=await U(L,{...r,stage:o});else throw new Error("Exactly one of treeFrom, valueFrom, or value must be specified")}if(g!==void 0)if(i==="@"){if(typeof g!="object")throw new Error(`Cannot set root value to "${g}"`);n=(0,Z.default)(n,g)}else{let R=i.split("__");for(;R.length>1;){let P=R.shift();if(y[P]||(y[P]={}),typeof y[P]!="object")throw new Error(`Cannot create tree path at ${i}`);y=y[P]}y[R[0]]=g}}return n}s(Ee,"resolveZeConfigItem");async function D(e,r,t="@"){if(e.startsWith("arn:aws:ssm")){if(!r.awsRegion)throw new Error(`Cannot resolve resource ${e} at ${t} without awsRegion`);return await de({region:r.awsRegion,name:e})}if(e.startsWith("env:"))return process.env[e.slice(4)];if(e.startsWith("func:"))switch(e.slice(5)){case"timestamp":return new Date().toISOString();case"stage":return r.stage;case"release":return r.release;default:throw new Error(`Unknown function '${e}' at '${t}'`)}throw new Error(`Cannot resolve resource '${e}' at '${t}'`)}s(D,"resolveResource");async function U(e,r,t){if(e!=null){if(typeof e=="object")for(let[o,n]of Object.entries(e))e[o]=await U(n,r,`${t}.${o}`);else if(typeof e=="string"&&e.startsWith("${")&&e.endsWith("}"))return await D(e.slice(2,-1),r)}return e}s(U,"resolveConfig");var k=require("zod");function j(){return"4.0.0"}s(j,"getVersion");var Se=d(require("fs"),1),H=d(require("path"),1),Ae=require("js-yaml");var Lr=require("reflect-metadata"),xe=d(require("path"),1);async function Qe(e){let{default:r}=await import("simple-git");return r(e)}s(Qe,"simpleGit");async function Oe(e){return(await(await Qe(e)).raw("rev-parse","HEAD")).trim()}s(Oe,"getSha");var z=Symbol("options_key");function x(e){return(r,t)=>{var o,n;if(e!=null){let i={...Reflect.getMetadata(z,r)||{},[t]:{...e,describe:e.envAlias?`${e.describe||""} [${e.envAlias}]`:e.describe,type:e.type||((n=(o=Reflect.getMetadata("design:type",r,t))==null?void 0:o.name)==null?void 0:n.toLowerCase())}};Reflect.defineMetadata(z,i,r)}}}s(x,"YargOption");function Re(e){let r=Reflect.getMetadata(z,e.prototype);if(!r)throw new Error(`Options for ${e.name} were not defined`);return r}s(Re,"getYargsOption");function Te(e){return async r=>r.options(Xe(e)).middleware(async t=>await er(e,t),!0)}s(Te,"getBuilder");function Xe(e){return Object.entries(Re(e)).reduce((r,[t,o])=>(r[t]=Object.fromEntries(Object.entries(o).filter(([n])=>!["envAlias","default"].includes(n))),r),{})}s(Xe,"getYargsOptions");async function er(e,r){let t=new e;if(t.pwd=xe.default.resolve(r.pwd||process.env.PWD||process.cwd()),!t.pwd)throw new Error("No PWD given");t.release||(t.release=process.env.RELEASE||process.env.RELEASE_SHA||await Oe(t.pwd));for(let[o,n]of Object.entries(Re(e)))["pwd","release"].includes(o)||(t[o]=(r[o]||n.envAlias&&process.env[n.envAlias])??n.default);return t}s(er,"loadYargsConfig");var w=class w{pwd;stage;release;verbose;target};s(w,"InjectOptions"),b([x({envAlias:"PWD",demandOption:!0})],w.prototype,"pwd",2),b([x({envAlias:"STAGE",demandOption:!0})],w.prototype,"stage",2),b([x({envAlias:"RELEASE",demandOption:!0})],w.prototype,"release",2),b([x({envAlias:"VERBOSE",default:!1})],w.prototype,"verbose",2),b([x({default:!1})],w.prototype,"target",2);var K=w,ve={command:"inject [target]",describe:"Inject config into the app",builder:Te(K),handler:async e=>{let r=await e;return r.verbose&&(O("spaDeploy",j()),O("nodejs",process.version),O("pwd",r.pwd),O("release",r.release),O("stage",r.stage)),rr({pwd:r.pwd,stage:r.stage,release:r.release,target:r.target,verbose:r.verbose})}};async function rr(e){var t;let r=await be("spa-deploy",e.pwd,e.stage,k.z.object({inject:ye,aws:k.z.object({region:k.z.string().optional()}).optional()}));for(let o of r.inject){if(e.target&&o.name!==e.target)continue;let n=await Ee(o,{awsRegion:(t=r.aws)==null?void 0:t.region,release:e.release},e.pwd,e.stage),{destination:i}=o,a=tr(H.default.basename(i),n),u=H.default.join(e.pwd,i);a&&(console.log(`Writing ${u}`),Se.default.writeFileSync(u,a))}}s(rr,"inject");function tr(e,r){if(e.endsWith(".json"))return JSON.stringify(r,null,2);if(e.endsWith(".yml")||e.endsWith(".yaml"))return(0,Ae.dump)(r);if(e.endsWith(".env")||e.startsWith(".env")){let t=[];for(let[o,n]of Object.entries(r))typeof n=="string"?t.push(`${o}=${n}`):t.push(`${o}=${JSON.stringify(n)}`);return t.join(`
`)}else throw new Error(`Unknown destination file type: ${e}`)}s(tr,"generate");(0,$e.default)((0,Pe.hideBin)(process.argv)).version(j()||"unknown").scriptName("spa-deploy").command(ve).help().demandCommand(1).strictCommands(!0).showHelpOnFail(!0).fail((e,r)=>{e&&v(e),r&&v(r),ue("Use '--help' for more info"),process.exit(1)}).parse();
